import{e as m,i as A,j as y}from"./chunk-2BORB4XM.js";import{fromNullable as G}from"@dfinity/utils";import{Delegation as E,ECDSAKeyIdentity as k}from"@icp-sdk/core/identity";import{getConsoleActor as P,getSatelliteActor as S}from"@junobuild/ic-client/actor";var l=({auth:t,identity:e})=>"satellite"in t?S({...t.satellite,identity:e}):P({...t.console,identity:e});var p=async({actorParams:t,args:e})=>{let{authenticate:n}=await l(t);return await n(e)},d=async({actorParams:t,args:e})=>{let{get_delegation:n}=await l(t);return await n(e)};import{DelegationChain as C,DelegationIdentity as I}from"@icp-sdk/core/identity";var h=({delegations:t,sessionKey:e})=>{let[n,i]=t,o=C.fromDelegations(i,Uint8Array.from(n));return{identity:I.fromDelegation(e,o),delegationChain:o,sessionKey:e}};var F=async({jwt:t,context:e,auth:n})=>{let i=await k.generate({extractable:!1}),o=new Uint8Array(i.getPublicKey().toDer()),{delegations:a,data:g}=await K({jwt:t,publicKey:o,context:e,auth:n});return{identity:h({sessionKey:i,delegations:a}),data:g}},K=async({jwt:t,publicKey:e,context:{caller:n,salt:i},auth:o})=>{let a=await p({args:{OpenId:{jwt:t,session_key:e,salt:i}},actorParams:{auth:o,identity:n}});if("Err"in a)throw new m("Authentication failed",{cause:a});let{delegation:{user_key:g,expiration:r},...u}=a.Ok,s=await b({jwt:t,context:{caller:n,salt:i},auth:o,publicKey:e,expiration:r}),{delegation:c,signature:D}=s,{pubkey:f,expiration:x,targets:w}=c;return{delegations:[g,[{delegation:new E(Uint8Array.from(f),x,G(w)),signature:Uint8Array.from(D)}]],data:u}},b=async({jwt:t,publicKey:e,context:{salt:n,caller:i},auth:o,expiration:a,maxRetries:g=5})=>{for(let r=0;r<g;r++){await new Promise(c=>{setInterval(c,1e3*r)});let s=await d({args:{OpenId:{jwt:t,session_key:e,salt:n,expiration:a}},actorParams:{auth:o,identity:i}});if("Err"in s){let{Err:c}=s;if("NoSuchDelegation"in c||"GetCachedJwks"in c)continue;throw new A("Getting delegation failed",{cause:s})}return s.Ok}throw new y};export{F as a};
//# sourceMappingURL=chunk-PIJCHIUI.js.map
