import { createRequire as topLevelCreateRequire } from 'module';
 const require = topLevelCreateRequire(import.meta.url);
import{isEmptyString as _}from"@dfinity/utils";import{isNullish as Q}from"@dfinity/utils";import{Ed25519KeyIdentity as Z}from"@icp-sdk/core/identity";var S="juno:auth:openid",C={authUrl:"https://accounts.google.com/o/oauth2/v2/auth",authScopes:["openid","profile","email"],configUrl:"https://accounts.google.com/gsi/fedcm.json"};var d=class extends Error{},u=class extends Error{},l=class extends Error{},y=class extends Error{},g=class extends Error{},h=class extends Error{},f=class extends Error{},A=class extends Error{},x=class extends Error{},w=class extends Error{};import{arrayBufferToUint8Array as F}from"@dfinity/utils";import{uint8ArrayToBase64 as V}from"@dfinity/utils";var P=t=>V(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");var M=()=>window.crypto.getRandomValues(new Uint8Array(32)),X=async({salt:t,caller:e})=>{let r=e.getPrincipal().toUint8Array(),o=new Uint8Array(t.length+r.byteLength);o.set(t),o.set(r,t.length);let n=await window.crypto.subtle.digest("SHA-256",o);return P(F(n))},I=async({caller:t})=>{let e=M();return{nonce:await X({salt:e,caller:t}),salt:e}};import{base64ToUint8Array as $,uint8ArrayToBase64 as z}from"@dfinity/utils";import{Ed25519KeyIdentity as H}from"@icp-sdk/core/identity";var D="__caller__",O="__salt__",J="__state__",U=({caller:t,state:e,salt:r})=>{let o={[D]:t.toJSON(),[O]:z(r),[J]:e};return JSON.stringify(o)},T=t=>{let{[D]:e,[O]:r,[J]:o}=JSON.parse(t);return{caller:H.fromParsedJson(e),salt:$(r),state:o}};var q=()=>P(window.crypto.getRandomValues(new Uint8Array(12)));var K=async()=>{let t=Z.generate(),{nonce:e,salt:r}=await I({caller:t}),o=q(),n=U({caller:t,salt:r,state:o});return sessionStorage.setItem(S,n),{nonce:e,state:o}},N=()=>{let t=sessionStorage.getItem(S);if(Q(t))throw new u;return T(t)};import{fromNullable as nt}from"@dfinity/utils";import{Delegation as st,ECDSAKeyIdentity as it}from"@icp-sdk/core/identity";import{getConsoleActor as tt,getSatelliteActor as et}from"@junobuild/ic-client/actor";var R=({auth:t,identity:e})=>"satellite"in t?et({...t.satellite,identity:e}):tt({...t.console,identity:e});var k=async({actorParams:t,args:e})=>{let{authenticate:r}=await R(t);return await r(e)},v=async({actorParams:t,args:e})=>{let{get_delegation:r}=await R(t);return await r(e)};import{DelegationChain as rt,DelegationIdentity as ot}from"@icp-sdk/core/identity";var L=({delegations:t,sessionKey:e})=>{let[r,o]=t,n=rt.fromDelegations(o,Uint8Array.from(r));return{identity:ot.fromDelegation(e,n),delegationChain:n,sessionKey:e}};var E=async({jwt:t,context:e,auth:r})=>{let o=await it.generate({extractable:!1}),n=new Uint8Array(o.getPublicKey().toDer()),{delegations:s,data:i}=await at({jwt:t,publicKey:n,context:e,auth:r});return{identity:L({sessionKey:o,delegations:s}),data:i}},at=async({jwt:t,publicKey:e,context:{caller:r,salt:o},auth:n})=>{let s=await k({args:{OpenId:{jwt:t,session_key:e,salt:o}},actorParams:{auth:n,identity:r}});if("Err"in s)throw new g("Authentication failed",{cause:s});let{delegation:{user_key:i,expiration:c},...a}=s.Ok,p=await ct({jwt:t,context:{caller:r,salt:o},auth:n,publicKey:e,expiration:c}),{delegation:m,signature:W}=p,{pubkey:j,expiration:B,targets:Y}=m;return{delegations:[i,[{delegation:new st(Uint8Array.from(j),B,nt(Y)),signature:Uint8Array.from(W)}]],data:a}},ct=async({jwt:t,publicKey:e,context:{salt:r,caller:o},auth:n,expiration:s,maxRetries:i=5})=>{for(let c=0;c<i;c++){await new Promise(m=>{setInterval(m,1e3*c)});let p=await v({args:{OpenId:{jwt:t,session_key:e,salt:r,expiration:s}},actorParams:{auth:n,identity:o}});if("Err"in p){let{Err:m}=p;if("NoSuchDelegation"in m||"GetCachedJwks"in m)continue;throw new x("Getting delegation failed",{cause:p})}return p.Ok}throw new w};var $t=async t=>{let e=N();if("credentials"in t){let{credentials:{jwt:r},auth:o}=t;return await E({jwt:r,context:e,auth:o})}return await pt({...t,context:e})},pt=async({auth:t,context:e})=>{let{location:{hash:r}}=window;if(_(r)||!r.startsWith("#"))throw new h("No hash found in the current location URL");let o=new URLSearchParams(r.slice(1)),n=o.get("state"),s=o.get("id_token"),{state:i}=e;if(_(i)||n!==i)throw new f("The provided state is invalid",{cause:n});if(_(s))throw new A;return await E({jwt:s,auth:t,context:e})};import{isNullish as mt,notEmptyString as dt}from"@dfinity/utils";var b=({authUrl:t,clientId:e,nonce:r,loginHint:o,authScopes:n,state:s,redirectUrl:i})=>{let a=(()=>{try{return new URL(t)}catch{throw new d("Cannot parse authURL",{cause:t})}})();a.searchParams.set("client_id",e);let{location:{origin:p}}=window;a.searchParams.set("redirect_uri",i??p),a.searchParams.set("response_type","code id_token"),a.searchParams.set("scope",n.join(" ")),a.searchParams.set("state",s),a.searchParams.set("nonce",r),dt(o)?a.searchParams.set("login_hint",o):a.searchParams.set("prompt","select_account"),window.location.href=a.toString()},G=async({configUrl:t,clientId:e,nonce:r,loginHint:o,domainHint:n})=>{let s=await navigator.credentials.get({identity:{context:"use",providers:[{configURL:t,clientId:e,nonce:r,loginHint:o,domainHint:n}],mode:"active"},mediation:"required"});if(mt(s))throw new l;let{type:i}=s;if(i!=="identity"||!("token"in s)||typeof s.token!="string")throw new y("Invalid credential received from FedCM API",{cause:s});let{token:c}=s;return{jwt:c}};async function oe({google:t}){let e=await K();if("credentials"in t){let{credentials:s}=t,{configUrl:i}=C;return await G({...s,...e,configUrl:i})}let{redirect:r}=t,{authUrl:o,authScopes:n}=C;b({...r,...e,authUrl:o,authScopes:n})}var se=()=>{let{userAgent:t}=navigator;return/SamsungBrowser/i.test(t)?!1:"IdentityCredential"in window};export{g as AuthenticationError,f as AuthenticationInvalidStateError,A as AuthenticationUndefinedJwtError,h as AuthenticationUrlHashError,u as ContextUndefinedError,y as FedCMIdentityCredentialInvalidError,l as FedCMIdentityCredentialUndefinedError,x as GetDelegationError,w as GetDelegationRetryError,d as InvalidUrlError,$t as authenticate,se as isFedCMSupported,oe as requestJwt};
//# sourceMappingURL=index.mjs.map
