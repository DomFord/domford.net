{"version":3,"file":"storage.js","sources":["../../../src/client/storage.ts"],"sourcesContent":["import { type DBCreateOptions, IdbKeyVal } from './db.ts';\n\nexport const KEY_STORAGE_KEY = 'identity';\nexport const KEY_STORAGE_DELEGATION = 'delegation';\nexport const KEY_VECTOR = 'iv';\n// Increment if any fields are modified\nexport const DB_VERSION = 1;\n\nexport type StoredKey = string | CryptoKeyPair;\n\n/**\n * Interface for persisting user authentication data\n */\nexport interface AuthClientStorage {\n  get(key: string): Promise<StoredKey | null>;\n\n  set(key: string, value: StoredKey): Promise<void>;\n\n  remove(key: string): Promise<void>;\n}\n\n/**\n * Legacy implementation of AuthClientStorage, for use where IndexedDb is not available\n */\nexport class LocalStorage implements AuthClientStorage {\n  constructor(\n    public readonly prefix = 'ic-',\n    private readonly _localStorage?: Storage,\n  ) {}\n\n  public get(key: string): Promise<string | null> {\n    return Promise.resolve(this._getLocalStorage().getItem(this.prefix + key));\n  }\n\n  public set(key: string, value: string): Promise<void> {\n    this._getLocalStorage().setItem(this.prefix + key, value);\n    return Promise.resolve();\n  }\n\n  public remove(key: string): Promise<void> {\n    this._getLocalStorage().removeItem(this.prefix + key);\n    return Promise.resolve();\n  }\n\n  private _getLocalStorage() {\n    if (this._localStorage) {\n      return this._localStorage;\n    }\n\n    const ls = globalThis.localStorage;\n    if (!ls) {\n      throw new Error('Could not find local storage.');\n    }\n\n    return ls;\n  }\n}\n\n/**\n * IdbStorage is an interface for simple storage of string key-value pairs built on {@link IdbKeyVal}\n *\n * It replaces {@link LocalStorage}\n * @see implements {@link AuthClientStorage}\n */\nexport class IdbStorage implements AuthClientStorage {\n  #options: DBCreateOptions;\n\n  /**\n   * @param options - DBCreateOptions\n   * @param options.dbName - name for the indexeddb database\n   * @param options.storeName - name for the indexeddb Data Store\n   * @param options.version - version of the database. Increment to safely upgrade\n   * @example\n   * ```ts\n   * const storage = new IdbStorage({ dbName: 'my-db', storeName: 'my-store', version: 2 });\n   * ```\n   */\n  constructor(options?: DBCreateOptions) {\n    this.#options = options ?? {};\n  }\n\n  // Initializes a KeyVal on first request\n  private initializedDb: IdbKeyVal | undefined;\n  get _db(): Promise<IdbKeyVal> {\n    return new Promise((resolve, reject) => {\n      if (this.initializedDb) {\n        resolve(this.initializedDb);\n        return;\n      }\n      IdbKeyVal.create(this.#options)\n        .then((db) => {\n          this.initializedDb = db;\n          resolve(db);\n        })\n        .catch(reject);\n    });\n  }\n\n  public async get<T = string>(key: string): Promise<T | null> {\n    const db = await this._db;\n    return await db.get<T>(key);\n    // return (await db.get<string>(key)) ?? null;\n  }\n\n  public async set<T = string>(key: string, value: T): Promise<void> {\n    const db = await this._db;\n    await db.set(key, value);\n  }\n\n  public async remove(key: string): Promise<void> {\n    const db = await this._db;\n    await db.remove(key);\n  }\n}\n"],"names":[],"mappings":";AAEO,MAAM,kBAAkB;AACxB,MAAM,yBAAyB;AAC/B,MAAM,aAAa;AAEnB,MAAM,aAAa;AAkBnB,MAAM,aAA0C;AAAA,EACrD,YACkB,SAAS,OACR,eACjB;AAFgB,SAAA,SAAA;AACC,SAAA,gBAAA;AAAA,EAChB;AAAA,EAEI,IAAI,KAAqC;AAC9C,WAAO,QAAQ,QAAQ,KAAK,iBAAA,EAAmB,QAAQ,KAAK,SAAS,GAAG,CAAC;AAAA,EAC3E;AAAA,EAEO,IAAI,KAAa,OAA8B;AACpD,SAAK,mBAAmB,QAAQ,KAAK,SAAS,KAAK,KAAK;AACxD,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA,EAEO,OAAO,KAA4B;AACxC,SAAK,iBAAA,EAAmB,WAAW,KAAK,SAAS,GAAG;AACpD,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA,EAEQ,mBAAmB;AACzB,QAAI,KAAK,eAAe;AACtB,aAAO,KAAK;AAAA,IACd;AAEA,UAAM,KAAK,WAAW;AACtB,QAAI,CAAC,IAAI;AACP,YAAM,IAAI,MAAM,+BAA+B;AAAA,IACjD;AAEA,WAAO;AAAA,EACT;AACF;AAQO,MAAM,WAAwC;AAAA,EACnD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,YAAY,SAA2B;AACrC,SAAK,WAAW,WAAW,CAAA;AAAA,EAC7B;AAAA;AAAA,EAGQ;AAAA,EACR,IAAI,MAA0B;AAC5B,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAI,KAAK,eAAe;AACtB,gBAAQ,KAAK,aAAa;AAC1B;AAAA,MACF;AACA,gBAAU,OAAO,KAAK,QAAQ,EAC3B,KAAK,CAAC,OAAO;AACZ,aAAK,gBAAgB;AACrB,gBAAQ,EAAE;AAAA,MACZ,CAAC,EACA,MAAM,MAAM;AAAA,IACjB,CAAC;AAAA,EACH;AAAA,EAEA,MAAa,IAAgB,KAAgC;AAC3D,UAAM,KAAK,MAAM,KAAK;AACtB,WAAO,MAAM,GAAG,IAAO,GAAG;AAAA,EAE5B;AAAA,EAEA,MAAa,IAAgB,KAAa,OAAyB;AACjE,UAAM,KAAK,MAAM,KAAK;AACtB,UAAM,GAAG,IAAI,KAAK,KAAK;AAAA,EACzB;AAAA,EAEA,MAAa,OAAO,KAA4B;AAC9C,UAAM,KAAK,MAAM,KAAK;AACtB,UAAM,GAAG,OAAO,GAAG;AAAA,EACrB;AACF;"}